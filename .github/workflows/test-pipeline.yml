name: BookKeeper Tests - JUnit, Coverage & Mutation Testing

on:
  push:
    branches: [ main, master, develop, 'feature/**' ]
    paths:
      - 'bookkeeper-tests-demo/**'
      - '.github/workflows/test-pipeline.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'bookkeeper-tests-demo/**'
      - '.github/workflows/test-pipeline.yml'
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  test:
    name: Build and Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java-version: ['11', '17']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: maven

      - name: Display Java version
        run: java -version

      - name: Build BookKeeper Parent POM (Skip Tests and Native)
        run: |
          mvn clean install -DskipTests=true -q -T 1C -Pskip-native 2>/dev/null || \
          mvn clean install -DskipTests=true -q -T 1C -Dnar.skip=true 2>/dev/null || \
          echo "Skipping native modules..."

      - name: Run Maven build (Demo Tests)
        run: |
          cd bookkeeper-tests-demo
          mvn clean package -DskipTests=false -q

      - name: Run Unit Tests with Surefire
        id: test
        run: |
          cd bookkeeper-tests-demo
          mvn test -q
        continue-on-error: true

      - name: Generate JaCoCo Coverage Report
        run: |
          cd bookkeeper-tests-demo
          mvn jacoco:report
        continue-on-error: true

      - name: Upload JaCoCo Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./bookkeeper-tests-demo/target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true
        continue-on-error: true

      - name: Check Test Results
        if: steps.test.outcome == 'failure'
        run: |
          echo "Tests failed! Check the logs above for details."
          exit 1

      - name: Display Test Summary
        run: |
          echo "=== TEST SUMMARY ===" 
          if [ -f bookkeeper-tests-demo/target/surefire-reports/*.txt ]; then
            cat bookkeeper-tests-demo/target/surefire-reports/*.txt
          fi

  coverage-check:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Generate Coverage Report
        run: |
          cd bookkeeper-tests-demo
          mvn clean test jacoco:report -q

      - name: Check Coverage Threshold
        run: |
          cd bookkeeper-tests-demo
          # Extract coverage percentage from jacoco.xml
          COVERAGE=$(grep -oP 'line-rate="\K[^"]*' target/site/jacoco/jacoco.xml 2>/dev/null | head -1)
          echo "Code Coverage: ${COVERAGE}%"
          
          # Convert to percentage (jacoco reports as decimal)
          if [ ! -z "$COVERAGE" ]; then
            COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc)
            echo "Coverage percentage: ${COVERAGE_PCT}%"
            
            # Threshold check (if needed)
            MIN_COVERAGE=0  # Set to 80 for production
            # if (( $(echo "$COVERAGE_PCT < $MIN_COVERAGE" | bc -l) )); then
            #   echo "Coverage below minimum threshold of ${MIN_COVERAGE}%"
            #   exit 1
            # fi
          fi

      - name: Upload Coverage Report as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: jacoco-coverage-report-java11
          path: bookkeeper-tests-demo/target/site/jacoco/
        if: always()

  mutation-testing:
    name: Mutation Testing (PITest)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Run PITest Mutation Testing
        run: |
          cd bookkeeper-tests-demo
          mvn clean org.pitest:pitest-maven:mutationCoverage -q
        continue-on-error: true

      - name: Upload Mutation Report as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: pitest-mutation-report
          path: bookkeeper-tests-demo/target/pit-reports/
        if: always()

      - name: Display Mutation Test Summary
        run: |
          echo "=== MUTATION TESTING SUMMARY ==="
          if [ -d bookkeeper-tests-demo/target/pit-reports/ ]; then
            ls -la bookkeeper-tests-demo/target/pit-reports/
          else
            echo "No mutation test report found"
          fi
        if: always()

  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: test
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Run Tests and Generate Report
        run: |
          cd bookkeeper-tests-demo
          mvn test surefire-report:report -q
        continue-on-error: true

      - name: Upload Surefire Report as Artifact
        uses: actions/upload-artifact@v3
        with:
          name: surefire-test-report
          path: bookkeeper-tests-demo/target/site/surefire-report.html
        if: always()

  summary:
    name: Test Execution Summary
    runs-on: ubuntu-latest
    needs: [test, coverage-check, mutation-testing, test-report]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Summary
        run: |
          echo "### üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Status:** $([ '${{ needs.test.result }}' == 'success' ] && echo '‚úÖ SUCCESS' || echo '‚ùå FAILURE')" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage Status:** $([ '${{ needs.coverage-check.result }}' == 'success' ] && echo '‚úÖ PASSED' || echo '‚ö†Ô∏è CHECK NEEDED')" >> $GITHUB_STEP_SUMMARY
          echo "**Mutation Testing:** $([ '${{ needs.mutation-testing.result }}' == 'success' ] && echo '‚úÖ COMPLETED' || echo '‚ö†Ô∏è CHECK NEEDED')" >> $GITHUB_STEP_SUMMARY
          echo "**Report Status:** $([ '${{ needs.test-report.result }}' == 'success' ] && echo '‚úÖ GENERATED' || echo '‚ö†Ô∏è CHECK NEEDED')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Artifacts Generated:" >> $GITHUB_STEP_SUMMARY
          echo "- üìä JaCoCo Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "- üß¨ PITest Mutation Report" >> $GITHUB_STEP_SUMMARY
          echo "- üìù Surefire Test Report" >> $GITHUB_STEP_SUMMARY

      - name: Notify Results
        run: |
          echo "=== üéØ CI/CD PIPELINE COMPLETED ==="
          echo "All tests and analysis tools executed successfully!"
          echo "Check artifacts tab for detailed reports."

  pull-request-comment:
    name: Add PR Comment
    runs-on: ubuntu-latest
    needs: [test, coverage-check]
    if: github.event_name == 'pull_request'

    steps:
      - name: Comment PR with Results
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ needs.test.result }}';
            const coverageResult = '${{ needs.coverage-check.result }}';
            
            const status = testResult === 'success' ? '‚úÖ' : '‚ùå';
            const coverageStatus = coverageResult === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            
            const body = `## Test Results
            
            ${status} **Unit Tests:** ${testResult.toUpperCase()}
            ${coverageStatus} **Code Coverage:** ${coverageResult === 'success' ? 'Passed' : 'Check needed'}
            
            See [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed reports.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
