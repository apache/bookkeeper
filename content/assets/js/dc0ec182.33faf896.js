"use strict";(self.webpackChunksite_3=self.webpackChunksite_3||[]).push([[847],{15680:(e,t,a)=>{a.d(t,{xA:()=>s,yg:()=>u});var n=a(96540);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var d=n.createContext({}),p=function(e){var t=n.useContext(d),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},s=function(e){var t=p(e.components);return n.createElement(d.Provider,{value:t},e.children)},m="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},g=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,d=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),m=p(a),g=i,u=m["".concat(d,".").concat(g)]||m[g]||c[g]||r;return a?n.createElement(u,o(o({ref:t},s),{},{components:a})):n.createElement(u,o({ref:t},s))}));function u(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=g;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l[m]="string"==typeof e?e:i,o[1]=l;for(var p=2;p<r;p++)o[p]=a[p];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}g.displayName="MDXCreateElement"},97780:(e,t,a)=>{a.r(t),a.d(t,{contentTitle:()=>o,default:()=>m,frontMatter:()=>r,metadata:()=>l,toc:()=>d});var n=a(9668),i=(a(96540),a(15680));const r={},o="BP-29: Metadata API module",l={type:"mdx",permalink:"/bps/BP-29-metadata-store-api-module",source:"@site/src/pages/bps/BP-29-metadata-store-api-module.md",title:"BP-29: Metadata API module",description:"Motivation",frontMatter:{}},d=[{value:"Motivation",id:"motivation",level:3},{value:"Public Interfaces",id:"public-interfaces",level:3},{value:"Proposed Changes",id:"proposed-changes",level:3},{value:"Configuration",id:"configuration",level:4},{value:"Metadata Stores",id:"metadata-stores",level:4},{value:"Compatibility, Deprecation, and Migration Plan",id:"compatibility-deprecation-and-migration-plan",level:3},{value:"Test Plan",id:"test-plan",level:3},{value:"Rejected Alternatives",id:"rejected-alternatives",level:3}],p={toc:d},s="wrapper";function m(e){let{components:t,...a}=e;return(0,i.yg)(s,(0,n.A)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"bp-29-metadata-api-module"},"BP-29: Metadata API module"),(0,i.yg)("h3",{id:"motivation"},"Motivation"),(0,i.yg)("p",null,"We have already abstracted all the metadata operations into interfaces. And all the bookkeeper implementations only reply on metadata interfaces,\nrather than depending on zookeeper. This proposal is to organize the metadata interfaces and its implementations in a separate module and make\nbookkeeper implementation only depends on metadata interfaces, not depends on zookeeper. This would a few benefits:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"It allows supporting different metadata storages, without bringing in dependencies of metadata store implementation directly into\nbookkeeper-server module. The development of different metadata storage can be done without interleaving with each other."),(0,i.yg)("li",{parentName:"ul"},"It would define a clean module dependency between bookkeeper implementation and metadata api, and how bookkeeper load a different metadata\nimplementation.")),(0,i.yg)("h3",{id:"public-interfaces"},"Public Interfaces"),(0,i.yg)("p",null,"A more generic setting ",(0,i.yg)("inlineCode",{parentName:"p"},"metadataServiceUri")," is introduced for replacing implementation specific settings ",(0,i.yg)("inlineCode",{parentName:"p"},"zkServers")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"zkLedgersRootPath"),"."),(0,i.yg)("p",null,"A metadata service uri defines the location of a metadata storage. In zookeeper based implementation, the metadata service url will be\n",(0,i.yg)("inlineCode",{parentName:"p"},"zk://<zkServers>/<zkLedgersRootPath>"),"."),(0,i.yg)("p",null,"This new setting in bookie configuration will be like as below:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"metadataServiceUri=zk://127.0.0.1/ledgers\n")),(0,i.yg)("p",null,"If we eventually support Etcd as one of the metadata storages. Then the setting in bookie configuration to use Etcd will be:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre"},"metadataServiceUri=etcd://<etcd_servers>/<etcd_key_prefix>\n")),(0,i.yg)("h3",{id:"proposed-changes"},"Proposed Changes"),(0,i.yg)("h4",{id:"configuration"},"Configuration"),(0,i.yg)("p",null,"This BP proposes introducing a more generic metadata setting ",(0,i.yg)("inlineCode",{parentName:"p"},"metadataServiceUri")," to replace implementation specific settings\n",(0,i.yg)("inlineCode",{parentName:"p"},"zkServers")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"zkLedgersRootPath"),". All implementation specific settings should be considered moving to implementation itself."),(0,i.yg)("p",null,"The ",(0,i.yg)("inlineCode",{parentName:"p"},"metadataServiceUri")," can also be used for replacing the need of configuring ",(0,i.yg)("inlineCode",{parentName:"p"},"ledgerManagerFactoryClass"),", ",(0,i.yg)("inlineCode",{parentName:"p"},"registrationClientClass")," and\n",(0,i.yg)("inlineCode",{parentName:"p"},"registrationManagerClass"),". It is unnecessarily complicated to configure multiple settings to load a specific metadata implementation.\nWe can just use the ",(0,i.yg)("inlineCode",{parentName:"p"},"scheme")," field in ",(0,i.yg)("inlineCode",{parentName:"p"},"metadataServiceUri")," to resolve which metadata implementation to use. Using uri to resolve\ndifferent driver or implementation is commonly seen at java world, for example, jdbc to support different database drivers. Also, distributedlog\nuses this pattern to load different metadata driver."),(0,i.yg)("p",null,"So in zookeeper based metadata implementation, the metadata service uri can be:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"zk+flat://127.0.0.1/ledgers"),': the scheme is "zk+flat". it means a zookeeper base metadata implementation and it uses flat ledger manager.'),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"zk+hierarchical://127.0.0.1/ledgers"),': the scheme is "zk+hierarchical". it means a zookeeper base metadata implementation and it\nuses hierarchical ledger manager.'),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"zk+longhierarchical://127.0.0.1/ledgers"),': the scheme is "zk+longhierarchical". it means a zookeeper base metadata implementation and it\nuses long hierarchical ledger manager.')),(0,i.yg)("h4",{id:"metadata-stores"},"Metadata Stores"),(0,i.yg)("p",null,"Introduce a new directory called ",(0,i.yg)("inlineCode",{parentName:"p"},"metadata-stores")," for storing all the metadata related modules. Under this directory, it will have following modules:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"api"),": it is the metadata api module ",(0,i.yg)("inlineCode",{parentName:"li"},"metadata-store-api"),". It contains all the files defining the metadata interfaces."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"zookeeper"),": it is the zookeeper implementation module ",(0,i.yg)("inlineCode",{parentName:"li"},"metadata-store-zookeeper"),". It contains all the files that implementing the metadata interfaces\nusing zookeeper.")),(0,i.yg)("p",null,"If a new metadata implementation is added, a new directory will be created under ",(0,i.yg)("inlineCode",{parentName:"p"},"metadata-stores")," to contain the implementation. For example, if we\nare adding ",(0,i.yg)("inlineCode",{parentName:"p"},"Etcd")," as the metadata store. A ",(0,i.yg)("inlineCode",{parentName:"p"},"Etcd")," directory will be created under ",(0,i.yg)("inlineCode",{parentName:"p"},"metadata-stores/etcd")," to store the files that implement metadata\ninterfaces using etcd client. And its module is named as ",(0,i.yg)("inlineCode",{parentName:"p"},"metadata-store-etcd"),"."),(0,i.yg)("p",null,"We then change bookkeeper-server to depend on ",(0,i.yg)("inlineCode",{parentName:"p"},"metadata-store-api")," only."),(0,i.yg)("p",null,"This approach is same as other pluggable modules ",(0,i.yg)("inlineCode",{parentName:"p"},"stats-api")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"http-server"),"."),(0,i.yg)("h3",{id:"compatibility-deprecation-and-migration-plan"},"Compatibility, Deprecation, and Migration Plan"),(0,i.yg)("p",null,"No compatibility concern at this moment. New setting is introduced and old settings will still continue to work.\nNo immediate deprecation.\nNo migration is needed."),(0,i.yg)("h3",{id:"test-plan"},"Test Plan"),(0,i.yg)("p",null,"This proposal is mostly around refactor. So existing test cases would cover this."),(0,i.yg)("h3",{id:"rejected-alternatives"},"Rejected Alternatives"),(0,i.yg)("p",null,"N/A"))}m.isMDXComponent=!0}}]);