<!DOCTYPE html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <title>Apache BookKeeper - BookKeeper Administrator&#39;s Guide</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="/archives/css/bootstrap.min.css" rel="stylesheet">
    <link href="/archives/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/archives/css/styles.css" rel="stylesheet">
  </head>
  <body>
    <header class="navbar navbar-inverse navbar-static-top" role="banner">
      <div class="container">
    	<div class="navbar-header hidden-xs hidden-sm">
    	  <a class="navbar-brand navbar-logo" href="/archives/"><img class="img-responsive" src="/archives/img/bookkeeper_blk40.png" alt="Bookkeeper Logo" /></a>
    	</div>
    	<div class="navbar-header">
    	  <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
    	  </button>
    	  <a class="navbar-brand" href="/archives/">Apache BookKeeper</a>
    	</div>
    	<nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
    	  <ul class="nav navbar-nav">
    	    <li><a href="/archives/releases.html">Download</a></li>

    	    <li class="dropdown">
    	      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Documentation<span class="caret"></span></a>
    	      <ul class="dropdown-menu" role="menu">
		<li><a href="/archives/docs/master">Latest (master)</a></li>
		<li><ul>
		    <li><a href="/archives/docs/master/apidocs">Java API docs</a></li>
		    <li><a href="/archives/docs/master/bookkeeperTutorial.html">Tutorial</a></li>
		    <li><a href="/archives/docs/master/bookkeeperConfig.html">Admin guide</a></li>
		</ul><li>
                <li><a href="/archives/docs/r4.4.0">Release 4.4.0</a></li>
                <li class="divider"></li>
                <li>Older releases</li>
                <li><a href="/archives/docs/r4.3.2">Release 4.3.2</a></li>
                <li><a href="/archives/docs/r4.3.1">Release 4.3.1</a></li>
                <li><a href="/archives/docs/r4.3.0">Release 4.3.0</a></li>
                <li><a href="/archives/docs/r4.2.4">Release 4.2.4</a></li>
                <li><a href="/archives/docs/r4.2.3">Release 4.2.3</a></li>
                <li><a href="/archives/docs/r4.2.2">Release 4.2.2</a></li>
                <li><a href="/archives/docs/r4.2.1">Release 4.2.1</a></li>
                <li><a href="/archives/docs/r4.2.0">Release 4.2.0</a></li>
                <li><a href="/archives/docs/r4.1.0">Release 4.1.0</a></li>
                <li><a href="/archives/docs/r4.0.0">Release 4.0.0</a></li>
              </ul>
            </li>
            
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Get Involved<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/archives/lists.html">Mailing Lists</a></li>
                <li><a href="/archives/irc.html">IRC</a></li>
                <li><a href="/archives/svn.html">Version Control</a></li>
                <li><a href="https://issues.apache.org/jira/browse/BOOKKEEPER">Issue Tracker</a></li>
              </ul>
            </li>

            <li><a href="https://cwiki.apache.org/confluence/display/BOOKKEEPER/Index">Wiki</a></li>
            <!--<li><a href="#">Hedwig</a></li>//-->
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Project Info<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/archives/credits.html">Who are we?</a></li>
                <li><a href="/archives/bylaws.html">Bylaws</a></li>
                <li><a href="http://www.apache.org/licenses/">License</a></li>
                <li class="divider"></li>
                <li><a href="/archives/privacy.html">Privacy Policy</a></li>
                <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsership</a></li>
                <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
              </ul>
            </li>
          </ul>
          <script>
            (function() {
            var cx = '017580107654524087317:iqnsyimpydg';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          
          <div class="navbar-form navbar-right visible-lg" id="googlebox">
            <gcse:searchbox-only></gcse:searchbox-only>
          </div>
        </nav>
      </div>
    </header>
    <div class="container">

 <h1>Abstract</h1>

<p>This document contains information about deploying, administering and maintaining BookKeeper. It also discusses best practices and common problems. </p>

<h1>Running a BookKeeper instance</h1>

<h2>System requirements</h2>

<p>A typical BookKeeper installation comprises a set of bookies and a set of ZooKeeper replicas. The exact number of bookies depends on the quorum mode, desired throughput, and number of clients using this installation simultaneously. The minimum number of bookies is three for self-verifying (stores a message authentication code along with each entry) and four for generic (does not store a message authentication code with each entry), and there is no upper limit on the number of bookies. Increasing the number of bookies will, in fact, enable higher throughput.</p>

<p>For performance, we require each server to have at least two disks. It is possible to run a bookie with a single disk, but performance will be significantly lower in this case.</p>

<p>For ZooKeeper, there is no constraint with respect to the number of replicas. Having a single machine running ZooKeeper in standalone mode is sufficient for BookKeeper. For resilience purposes, it might be a good idea to run ZooKeeper in quorum mode with multiple servers. Please refer to the ZooKeeper documentation for detail on how to configure ZooKeeper with multiple replicas.</p>

<h2>Starting and Stopping Bookies</h2>

<p>To <strong>start</strong> a bookie, execute the following command:</p>

<ul>
<li>To run a bookie in the foreground:<br />
<code>bookkeeper-server/bin/bookkeeper bookie</code></li>
</ul>

<ul>
<li>To run a bookie in the background:<br />
<code>bookkeeper-server/bin/bookkeeper-daemon.sh start bookie</code></li>
</ul>

<p>The configuration parameters can be set in bookkeeper-server/conf/bk_server.conf.</p>

<p>The important parameters are:</p>

<ul>
<li><code>bookiePort</code>, Port number that the bookie listens on; </li>
<li><code>zkServers</code>, Comma separated list of ZooKeeper servers with a hostname:port format; </li>
<li><code>journalDir</code>, Path for Log Device (stores bookie write-ahead log); </li>
<li><code>ledgerDir</code>, Path for Ledger Device (stores ledger entries); </li>
</ul>

<p>Ideally, <code>journalDir</code> and <code>ledgerDir</code> are each in a different device. See <a href="./bookieConfigParams.html">Bookie Configuration Parameters</a> for a full list of configuration parameters.</p>

<p>To <strong>stop</strong> a bookie running in the background, execute the following command:</p>

<p><code>bookkeeper-server/bin/bookkeeper-daemon.sh stop bookie [-force]</code><br />
<code>-force</code> is optional, which is used to stop the bookie forcefully, if the bookie server is not stopped gracefully within the <em><span class="caps">BOOKIE</span>_STOP_TIMEOUT</em> (environment variable), which is 30 seconds, by default.</p>

<h3>Upgrading</h3>

<p>From time to time, we may make changes to the filesystem layout of the bookie, which are incompatible with previous versions of bookkeeper and require that directories used with previous versions are upgraded. If you upgrade your bookkeeper software, and an upgrade is required, then the bookie will fail to start and print an error such as:</p>

<p><code>2012-05-25 10:41:50,494 - ERROR - [main:Bookie@246] - Directory layout version is less than 3, upgrade needed</code></p>

<p>BookKeeper provides a utility for upgrading the filesystem.<br />
<code>bookkeeper-server/bin/bookkeeper upgrade</code></p>

<p>The upgrade application takes 3 possible switches, <code>--upgrade</code>, <code>--rollback</code> or <code>--finalize</code>. A normal upgrade process looks like.</p>

<ol>
<li><code>bookkeeper-server/bin/bookkeeper upgrade --upgrade</code></li>
<li><code>bookkeeper-server/bin/bookkeeper bookie</code></li>
<li>Check everything is working. Kill bookie, ^C</li>
<li>If everything is ok, <code>bookkeeper-server/bin/bookkeeper upgrade --finalize</code></li>
<li>Start bookie again <code>bookkeeper-server/bin/bookkeeper bookie</code></li>
<li>If something is amiss, you can roll back the upgrade <code>bookkeeper-server/bin/bookkeeper upgrade --rollback</code></li>
</ol>

<h3>Formatting</h3>

<p>To format the bookie metadata in Zookeeper, execute the following command once:</p>

<p><code>bookkeeper-server/bin/bookkeeper shell metaformat [-nonInteractive] [-force]</code></p>

<p>To format the bookie local filesystem data, execute the following command on each bookie node:</p>

<p><code>bookkeeper-server/bin/bookkeeper shell bookieformat [-nonInteractive] [-force]</code></p>

<p>The <code>-nonInteractive</code> and <code>-force</code> switches are optional.</p>

<p>If <code>-nonInteractive</code> is set, the user will not be asked to confirm the format operation if old data exists. If it exists, the format operation will abort, unless the <code>-force</code> switch has been specified, in which case it will process.</p>

<p>By default, the user will be prompted to confirm the format operation if old data exists.</p>

<h3>Logging</h3>

<p>BookKeeper uses <a href="http://www.slf4j.org">slf4j</a> for logging, with the log4j bindings enabled by default. To enable logging from a bookie, create a log4j.properties file and point the environment variable <span class="caps">BOOKIE</span>_LOG_CONF to the configuration file. The path to the log4j.properties file must be absolute.</p>

<p><code>export BOOKIE_LOG_CONF=/tmp/log4j.properties</code><br />
<code>bookkeeper-server/bin/bookkeeper bookie</code></p>

<h3>Missing disks or directories</h3>

<p>Replacing disks or removing directories accidentally can cause a bookie to fail while trying to read a ledger fragment which the ledger metadata has claimed exists on the bookie. For this reason, when a bookie is started for the first time, it's disk configuration is fixed for the lifetime of that bookie. Any change to the disk configuration of the bookie, such as a crashed disk or an accidental configuration change, will result in the bookie being unable to start with the following error:</p>

<p><code>2012-05-29 18:19:13,790 - ERROR - [main:BookieServer@314] - Exception running bookie server : </code><br />
<code>org.apache.bookkeeper.bookie.BookieException$InvalidCookieException</code><br />
<code>.......at org.apache.bookkeeper.bookie.Cookie.verify(Cookie.java:82)</code><br />
<code>.......at org.apache.bookkeeper.bookie.Bookie.checkEnvironment(Bookie.java:275)</code><br />
<code>.......at org.apache.bookkeeper.bookie.Bookie.&lt;init&gt;(Bookie.java:351)</code></p>

<p>If the change was the result of an accidental configuration change, the change can be reverted and the bookie can be restarted. However, if the change cannot be reverted, such as is the case when you want to add a new disk or replace a disk, the bookie must be wiped and then all its data re-replicated onto it. To do this, do the following:</p>

<ol>
<li>Increment the <em>bookiePort</em> in <em>bk_server.conf</em>.</li>
<li>Ensure that all directories specified by <em>journalDirectory</em> and <em>ledgerDirectories</em> are empty.</li>
<li>Start the bookie.</li>
<li>Run <code>bin/bookkeeper org.apache.bookkeeper.tools.BookKeeperTools &lt;zkserver&gt; &lt;oldbookie&gt; &lt;newbookie&gt;</code> to re-replicate data. <oldbookie> and <newbookie> are identified by their external IP and bookiePort. For example if this process is being run on a bookie with an external IP of 192.168.1.10, with an old <em>bookiePort</em> of 3181 and a new <em>bookiePort</em> of 3182, and with zookeeper running on <em>zk1.example.com</em>, the command to run would be <br/><code>bin/bookkeeper org.apache.bookkeeper.tools.BookKeeperTools zk1.example.com 192.168.1.10:3181 192.168.1.10:3182</code>. See <a href="./bookieRecovery.html">Bookie Recovery</a> for more details on the re-replication process.</li>
</ol>

<p>The mechanism to prevent the bookie from starting up in the case of configuration changes exists to prevent the following silent failures:</p>

<ol>
<li>A strict subset of the ledger devices (among multiple ledger devices) has been replaced, consequently making the content of the replaced devices unavailable;</li>
<li>A strict subset of the ledger directories has been accidentally deleted.</li>
</ol>

<h2>Running Autorecovery nodes</h2>

<p>To run autorecovery nodes, we execute the following command in every Bookie node:<br />
 <code>bookkeeper-server/bin/bookkeeper autorecovery</code></p>

<p>Configuration parameters for autorecovery can be set in <strong>bookkeeper-server/conf/bk_server.conf</strong>.</p>

<p>Important parameters are:</p>

<ul>
<li><code>rereplicationEntryBatchSize</code> specifies the number of entries which a replication will rereplicate in parallel. The default value is 10. A larger value for this parameter will increase the speed at which autorecovery occurs but will increate the memory requirement of the autorecovery process, and create more load on the cluster.</li>
</ul>

<ul>
<li><code>openLedgerRereplicationGracePeriod</code>, is the amount of time, in milliseconds, which a recovery worker will wait before recovering a ledger segment which has no defined ended, i.e. the client is still writing to that segment. If the client is still active, it should detect the bookie failure, and start writing to a new ledger segment, and a new ensemble, which doesn't include the failed bookie. Creating new ledger segment will define the end of the previous segment. If, after the grace period, the ledger segment's end has not been defined, we assume the writing client has crashed. The ledger is fenced and the client is blocked from writing any more entries to the ledger. The default value is 30000ms.</li>
</ul>

<h3>Disabling Autorecovery during maintenance</h3>

<p>It is useful to disable autorecovery during maintenance, for example, to avoid a Bookie's data being unnecessarily rereplicated when it is only being taken down for a short period to update the software, or change the configuration.</p>

<p>To disable autorecovery, run:<br />
<code>bookkeeper-server/bin/bookkeeper shell autorecovery -disable</code></p>

<p>To reenable, run:<br />
<code>bookkeeper-server/bin/bookkeeper shell autorecovery -enable</code></p>

<p>Autorecovery enable/disable only needs to be run once for the whole cluster, and not individually on each Bookie in the cluster.</p>

<h2>Setting up a test ensemble</h2>

<p>Sometimes it is useful to run a ensemble of bookies on your local machine for testing. We provide a utility for doing this. It will set up N bookies, and a zookeeper instance locally. The data on these bookies and of the zookeeper instance are not persisted over restarts, so obviously this should never be used in a production environment. To run a test ensemble of 10 bookies, do the following:</p>

<p><code>bookkeeper-server/bin/bookkeeper localbookie 10</code></p>

    </div>
    <footer class="footer">
      <div class="container">
        <p class="text-muted">Copyright &copy; 2014 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.<br/>
	Apache BookKeeper, BookKeeper, Apache, Apache ZooKeeper, ZooKeeper, the Apache feather logo, and the Apache BookKeeper project logo are trademarks of The Apache Software Foundation.</p>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/archives/js/bootstrap.min.js"></script>
  </body>
</html>
