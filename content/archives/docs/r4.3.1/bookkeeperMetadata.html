<!DOCTYPE html>
<!--

    Licensed to the Apache Software Foundation (ASF) under one or more
    contributor license agreements.  See the NOTICE file distributed with
    this work for additional information regarding copyright ownership.
    The ASF licenses this file to You under the Apache License, Version 2.0
    (the "License"); you may not use this file except in compliance with
    the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE- 2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<html>
  <head>
    <title>Apache BookKeeper - BookKeeper Metadata Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link href="/archives/css/bootstrap.min.css" rel="stylesheet">
    <link href="/archives/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/archives/css/styles.css" rel="stylesheet">
  </head>
  <body>
    <header class="navbar navbar-inverse navbar-static-top" role="banner">
      <div class="container">
    	<div class="navbar-header hidden-xs hidden-sm">
    	  <a class="navbar-brand navbar-logo" href="/archives/"><img class="img-responsive" src="/archives/img/bookkeeper_blk40.png" alt="Bookkeeper Logo" /></a>
    	</div>
    	<div class="navbar-header">
    	  <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".bs-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
    	  </button>
    	  <a class="navbar-brand" href="/archives/">Apache BookKeeper</a>
    	</div>
    	<nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
    	  <ul class="nav navbar-nav">
    	    <li><a href="/archives/releases.html">Download</a></li>

    	    <li class="dropdown">
    	      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Documentation<span class="caret"></span></a>
    	      <ul class="dropdown-menu" role="menu">
		<li><a href="/archives/docs/master">Latest (master)</a></li>
		<li><ul>
		    <li><a href="/archives/docs/master/apidocs">Java API docs</a></li>
		    <li><a href="/archives/docs/master/bookkeeperTutorial.html">Tutorial</a></li>
		    <li><a href="/archives/docs/master/bookkeeperConfig.html">Admin guide</a></li>
		</ul><li>
                <li><a href="/archives/docs/r4.4.0">Release 4.4.0</a></li>
                <li class="divider"></li>
                <li>Older releases</li>
                <li><a href="/archives/docs/r4.3.2">Release 4.3.2</a></li>
                <li><a href="/archives/docs/r4.3.1">Release 4.3.1</a></li>
                <li><a href="/archives/docs/r4.3.0">Release 4.3.0</a></li>
                <li><a href="/archives/docs/r4.2.4">Release 4.2.4</a></li>
                <li><a href="/archives/docs/r4.2.3">Release 4.2.3</a></li>
                <li><a href="/archives/docs/r4.2.2">Release 4.2.2</a></li>
                <li><a href="/archives/docs/r4.2.1">Release 4.2.1</a></li>
                <li><a href="/archives/docs/r4.2.0">Release 4.2.0</a></li>
                <li><a href="/archives/docs/r4.1.0">Release 4.1.0</a></li>
                <li><a href="/archives/docs/r4.0.0">Release 4.0.0</a></li>
              </ul>
            </li>
            
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Get Involved<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/archives/lists.html">Mailing Lists</a></li>
                <li><a href="/archives/irc.html">IRC</a></li>
                <li><a href="/archives/svn.html">Version Control</a></li>
                <li><a href="https://issues.apache.org/jira/browse/BOOKKEEPER">Issue Tracker</a></li>
              </ul>
            </li>

            <li><a href="https://cwiki.apache.org/confluence/display/BOOKKEEPER/Index">Wiki</a></li>
            <!--<li><a href="#">Hedwig</a></li>//-->
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Project Info<span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="/archives/credits.html">Who are we?</a></li>
                <li><a href="/archives/bylaws.html">Bylaws</a></li>
                <li><a href="http://www.apache.org/licenses/">License</a></li>
                <li class="divider"></li>
                <li><a href="/archives/privacy.html">Privacy Policy</a></li>
                <li><a href="http://www.apache.org/foundation/sponsorship.html">Sponsership</a></li>
                <li><a href="http://www.apache.org/foundation/thanks.html">Thanks</a></li>
              </ul>
            </li>
          </ul>
          <script>
            (function() {
            var cx = '017580107654524087317:iqnsyimpydg';
            var gcse = document.createElement('script');
            gcse.type = 'text/javascript';
            gcse.async = true;
            gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
            '//www.google.com/cse/cse.js?cx=' + cx;
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(gcse, s);
            })();
          </script>
          
          <div class="navbar-form navbar-right visible-lg" id="googlebox">
            <gcse:searchbox-only></gcse:searchbox-only>
          </div>
        </nav>
      </div>
    </header>
    <div class="container">

 <h1>Metadata Management</h1>

<p>There are two kinds of metadata needs to be managed in BookKeeper: one is the <i>list of available bookies</i>, which is used to track server availability (ZooKeeper is designed naturally for this); while the other is <i>ledger metadata</i>, which could be handle by different kinds of key/value storages efficiently with <i><span class="caps">CAS </span>(Compare And Set)</i> semantics.</p>

<p><i>Ledger metadata</i> is handled by <i>LedgerManager</i> and can be plugged with various storage mediums.</p>

<h2>Ledger Metadata Management</h2>

<p>The operations on the metadata of a ledger are quite straightforward. They are:</p>

<ul>
<li><code>createLedger</code>: create an new entry to store given ledger metadata. A unique id should be generated as the ledger id for the new ledger.</li>
<li><code>removeLedgerMetadata</code>: remove the entry of a ledger from metadata store. A <i>Version</i> object is provided to do conditional remove. If given <i>Version</i> object doesn't match current <i>Version</i> in metadata store, <i>MetadataVersionException</i> should be thrown to indicate version confliction. <i>NoSuchLedgerExistsException</i> should be returned if the ledger metadata entry doesn't exists.</li>
<li><code>readLedgerMetadata</code>: read the metadata of a ledger from metadata store. The new <i>version</i> should be set to the returned <i>LedgerMetadata</i> object. <i>NoSuchLedgerExistsException</i> should be returned if the entry of the ledger metadata doesn't exists.</li>
<li><code>writeLedgerMetadata</code>: update the metadata of a ledger matching the given <i>Version</i>. The update should be rejected and <i>MetadataVersionException</i> should be returned whe then given <i>Version</i> doesn't match the current <i>Version</i> in metadata store. <i>NoSuchLedgerExistsException</i> should be returned if the entry of the ledger metadata doesn't exists. The version of the <i>LedgerMetadata</i> object should be set to the new <i>Version</i> generated by applying this update.</li>
<li><code>asyncProcessLedgers</code>: loops through all existed ledgers in metadata store and applies a <i>Processor</i>. The <i>Processor</i> provided is executed for each ledger. If a failure happens during iteration, the iteration should be teminated and <i>final callback</i> triggered with failure. Otherwise, <i>final callback</i> is triggered after all ledgers are processed. No ordering nor transactional guarantees need to be provided for in the implementation of this interface.</li>
<li><code>getLedgerRanges</code>: return a list of ranges for ledgers in the metadata store. The ledger metadata itself does not need to be fetched. Only the ledger ids are needed. No ordering is required, but there must be no overlap between ledger ranges and each ledger range must be contain all the ledgers in the metadata store between the defined endpoint (i.e. a ledger range [x, y], all ledger ids larger or equal to x and smaller or equal to y should exist only in this range). <i>getLedgerRanges</i> is used in the <i>ScanAndCompare</i> gc algorithm.</li>
</ul>

<h1>How to choose a metadata storage medium for BookKeeper.</h1>

<p>From the interface, several requirements need to met before choosing a metadata storage medium for BookKeeper:</p>

<ul>
<li><code>Check and Set (CAS)</code>: The ability to do strict update according to specific conditional. Etc, a specific version (ZooKeeper) and same content (HBase).</li>
<li><code>Optimized for Writes</code>: The metadata access pattern for BookKeeper is read first and continuous updates.</li>
<li><code>Optimized for Scans</code>: Scans are required for a <i>ScanAndCompare</i> gc algorithm.</li>
</ul>

<p><i>ZooKeeper</i> is the default implemention for BookKeeper metadata management, <i>ZooKeeper</i> holds data in memory and provides filesystem-like namespace and also meets all the above requirements. <i>ZooKeeper</i> could meet most of usages for BookKeeper. However, if you application needs to manage millions of ledgers, a more scalable solution would be <i>HBase</i>, which also meet the above requirements, but it more complicated to set up.</p>

    </div>
    <footer class="footer">
      <div class="container">
        <p class="text-muted">Copyright &copy; 2014 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.<br/>
	Apache BookKeeper, BookKeeper, Apache, Apache ZooKeeper, ZooKeeper, the Apache feather logo, and the Apache BookKeeper project logo are trademarks of The Apache Software Foundation.</p>
      </div>
    </footer>

    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/archives/js/bootstrap.min.js"></script>
  </body>
</html>
